<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Fitting HHH Models with Random Effects and Neighbourhood Structure — hhh4 • surveillance</title>
<script src="../deps/jquery-3.5.1/jquery-3.5.1.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-4.5.3/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-4.5.3/bootstrap.bundle.min.js"></script><script src="../deps/bs3compat-0.2.4/tabs.js"></script><script src="../deps/bs3compat-0.2.4/bs3compat.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><link rel="stylesheet" href="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.css">
<script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<link href="../syntax-highlighting.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Fitting HHH Models with Random Effects and Neighbourhood Structure — hhh4">
<meta property="og:description" content='Fits an autoregressive Poisson or negative binomial model
  to a univariate or multivariate time series of counts.
  The characteristic feature of hhh4 models is the additive
  decomposition of the conditional mean into epidemic and
  endemic components (Held et al, 2005).
  Log-linear predictors of covariates and random intercepts are allowed
  in all components; see the Details below.
  A general introduction to the hhh4 modelling approach and its
  implementation is given in the vignette("hhh4"). Meyer et al
  (2017, Section 5, available as vignette("hhh4_spacetime"))
  describe hhh4 models for areal time series of infectious
  disease counts.'>
<meta name="twitter:card" content="summary">
<meta name="twitter:creator" content="@bastistician">
<meta name="twitter:site" content="@bastistician">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc" data-headroom>
    

      <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    <a class="navbar-brand mb-0 h1" href="../index.html">surveillance</a>

    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <button type="button" id="version-badge" class="badge badge-default d-none d-lg-block" data-toggle="tooltip" data-placement="bottom" title="" data-original-title="Released version">1.19.1</button>

    <div id="navbar" class="collapse navbar-collapse">
      <ul class="navbar-nav mr-auto ml-3">
<li class="nav-item">
  <a class="nav-link" href="../articles/pkgdown/overview.html">Overview</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../articles/pkgdown/events.html">Events</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../articles/pkgdown/bibliography.html">Bibliography</a>
</li>
      </ul>
<ul class="navbar-nav ml-1"></ul>
</div>
  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <div class="col-md-9 contents">
    <img src="" class="pkg-logo" alt=""><div class="page-header pb-2 mt-4 mb-2 border-bottom toc-ignore">
    <h1 class="display-4">Fitting HHH Models with Random Effects and Neighbourhood Structure</h1>
    
    <div class="d-none name"><code>hhh4.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Fits an autoregressive Poisson or negative binomial model
  to a univariate or multivariate time series of counts.
  The characteristic feature of <code>hhh4</code> models is the additive
  decomposition of the conditional mean into <em>epidemic</em> and
  <em>endemic</em> components (Held et al, 2005).
  Log-linear predictors of covariates and random intercepts are allowed
  in all components; see the Details below.
  A general introduction to the <code>hhh4</code> modelling approach and its
  implementation is given in the <code>vignette("hhh4")</code>. Meyer et al
  (2017, Section 5, available as <code>vignette("hhh4_spacetime")</code>)
  describe <code>hhh4</code> models for areal time series of infectious
  disease counts.</p>
    </div>

    <pre class="usage"><code class="sourceCode R"><span class="fu">hhh4</span><span class="op">(</span><span class="va">stsObj</span>,
     control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
         ar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>f <span class="op">=</span> <span class="op">~</span> <span class="op">-</span><span class="fl">1</span>, offset <span class="op">=</span> <span class="fl">1</span>, lag <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,
         ne <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>f <span class="op">=</span> <span class="op">~</span> <span class="op">-</span><span class="fl">1</span>, offset <span class="op">=</span> <span class="fl">1</span>, lag <span class="op">=</span> <span class="fl">1</span>,
                   weights <span class="op">=</span> <span class="fu"><a href="stsSlots.html">neighbourhood</a></span><span class="op">(</span><span class="va">stsObj</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span>,
                   scale <span class="op">=</span> <span class="cn">NULL</span>, normalize <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,
         end <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>f <span class="op">=</span> <span class="op">~</span> <span class="fl">1</span>, offset <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,
         family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Poisson"</span>, <span class="st">"NegBin1"</span>, <span class="st">"NegBinM"</span><span class="op">)</span>,
         subset <span class="op">=</span> <span class="fl">2</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">stsObj</span><span class="op">)</span>,
         optimizer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>stop <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>tol<span class="op">=</span><span class="fl">1e-5</span>, niter<span class="op">=</span><span class="fl">100</span><span class="op">)</span>,
                          regression <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>method<span class="op">=</span><span class="st">"nlminb"</span><span class="op">)</span>,
                          variance <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>method<span class="op">=</span><span class="st">"nlminb"</span><span class="op">)</span><span class="op">)</span>,
         verbose <span class="op">=</span> <span class="cn">FALSE</span>,
         start <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>fixed<span class="op">=</span><span class="cn">NULL</span>, random<span class="op">=</span><span class="cn">NULL</span>, sd.corr<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span>,
         data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>t <span class="op">=</span> <span class="va">stsObj</span><span class="op">@</span><span class="va">epoch</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">stsObj</span><span class="op">@</span><span class="va">epoch</span><span class="op">)</span><span class="op">)</span>,
         keep.terms <span class="op">=</span> <span class="cn">FALSE</span>
     <span class="op">)</span>,
     check.analyticals <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre>

    <h2>Arguments</h2>
    <dl class="row" id="ref-arguments">
<dt class="col-sm-3" id="ref-arguments name">stsObj</dt>
      <dd class="col-sm-9" id="ref-arguments desc"><p>object of class <code>"<a href="sts-class.html">sts</a>"</code> containing the (multivariate)
    count data time series.</p></dd>
    <dt class="col-sm-3" id="ref-arguments name">control</dt>
      <dd class="col-sm-9" id="ref-arguments desc">
<p>a list containing the model specification and control arguments:</p>
<dl>
<dt><code>ar</code></dt>
<dd>
<p>Model for the autoregressive component given as
        list with the following components: 
        </p>
<dl>
<dt>f = ~ -1</dt>
<dd><p>a formula specifying \(\log(\lambda_{it})\)</p></dd>
	  <dt>offset = 1</dt>
<dd><p>optional multiplicative offset, either 1 or
	    a matrix of the same dimension as <code><a href="stsSlots.html">observed(stsObj)</a></code></p></dd>
	  <dt>lag = 1</dt>
<dd><p>a positive integer meaning autoregression on
	    \(y_{i,t-lag}\)</p></dd>
</dl>
</dd>
      <dt><code>ne</code></dt>
<dd>
<p>Model for the neighbour-driven component given as
       list with the following components:
	</p>
<dl>
<dt>f = ~ -1</dt>
<dd><p>a formula specifying \(\log(\phi_{it})\)</p></dd>
	  <dt>offset = 1</dt>
<dd><p>optional multiplicative offset, either 1 or
	    a matrix of the same dimension as <code><a href="stsSlots.html">observed(stsObj)</a></code></p></dd>
	  <dt>lag = 1</dt>
<dd><p>a non-negative integer meaning dependency on
	    \(y_{j,t-lag}\)</p></dd>
	  <dt>weights = neighbourhood(stsObj) == 1</dt>
<dd><p>neighbourhood weights \(w_{ji}\). The default
	    corresponds to the original formulation by Held et al
	    (2005), i.e., the spatio-temporal component incorporates an
	    unweighted sum over the lagged cases of the first-order
	    neighbours. See Paul et al (2008) and Meyer and Held (2014)
	    for alternative specifications, e.g.,
	    <code><a href="hhh4_W.html">W_powerlaw</a></code>.
	    Time-varying weights are possible by specifying an
	    array of <code><a href="https://rdrr.io/r/base/dim.html">dim()</a></code> <code><a href="https://rdrr.io/r/base/c.html">c(nUnits, nUnits, nTime)</a></code>, where
	    <code>nUnits=ncol(stsObj)</code> and <code>nTime=nrow(stsObj)</code>.</p></dd>
	  <dt>scale = NULL</dt>
<dd><p>optional matrix of the same dimensions as <code>weights</code> (or
	    a vector of length <code><a href="https://rdrr.io/r/base/nrow.html">ncol(stsObj)</a></code>) to scale the
	    <code>weights</code> to <code>scale * weights</code>.</p></dd>
	  <dt>normalize = FALSE</dt>
<dd><p>logical indicating if the (scaled) <code>weights</code> should be
	    normalized such that each row sums to 1.</p></dd>
</dl>
</dd>
      <dt><code>end</code></dt>
<dd>
<p>Model for the endemic component given as list
	with the following components
	</p>
<dl>
<dt>f = ~ 1</dt>
<dd><p>a formula specifying \(\log(\nu_{it})\)</p></dd>
	  <dt>offset = 1</dt>
<dd><p>optional multiplicative offset \(e_{it}\),
	    either 1 or a matrix of the same dimension as <code><a href="stsSlots.html">observed(stsObj)</a></code></p></dd>
</dl>
</dd>
      <dt><code>family</code></dt>
<dd><p>Distributional family -- either <code>"Poisson"</code>,
	or the Negative Binomial distribution. For the latter, the
	overdispersion parameter can be assumed to be the same for all
        units (<code>"NegBin1"</code>), to vary freely over all units
	(<code>"NegBinM"</code>), or to be shared by some units (specified by
        a factor of length <code><a href="https://rdrr.io/r/base/nrow.html">ncol(stsObj)</a></code> such that its number of
        levels determines the number of overdispersion parameters).
        Note that <code>"NegBinM"</code> is equivalent to
        <code><a href="https://rdrr.io/r/base/factor.html">factor(colnames(stsObj), levels = colnames(stsObj))</a></code>.</p></dd>
      <dt><code>subset</code></dt>
<dd><p>Typically <code>2:nrow(obs)</code> if model contains
	autoregression</p></dd>
      <dt><code>optimizer</code></dt>
<dd><p>a list of three lists of control arguments.	The <code>"stop"</code> list specifies two criteria for the outer
	optimization of regression and variance parameters: the relative
	<code>tol</code>erance for parameter change using the criterion 
	<code>max(abs(x[i+1]-x[i])) / max(abs(x[i]))</code>,
	and the maximum number <code>niter</code> of outer iterations.	Control arguments for the single optimizers are specified in the
	lists named <code>"regression"</code> and <code>"variance"</code>.
	<code>method="nlminb"</code> is the default optimizer for both (taking
	advantage of the analytical Fisher information matrices), however,
	the <code>method</code>s from <code><a href="https://rdrr.io/r/stats/optim.html">optim</a></code> may also be specified
	(as well as <code>"<a href="https://rdrr.io/r/stats/nlm.html">nlm</a>"</code> but that one is not recommended here).
	Especially for the variance updates, Nelder-Mead optimization
	(<code>method="Nelder-Mead"</code>) is an attractive alternative.
	All other elements of these two lists are passed as
	<code>control</code> arguments to the chosen <code>method</code>, e.g., if
	<code>method="nlminb"</code> adding <code>iter.max=50</code> increases the 
	maximum number of inner iterations from 20 (default) to 50.</p></dd>
      <dt><code>verbose</code></dt>
<dd><p>non-negative integer (usually in the range
	<code>0:3</code>) specifying the amount of tracing information to be
	output during optimization.</p></dd>
      <dt><code>start</code></dt>
<dd><p>a list of initial parameter values replacing
	initial values set via <code><a href="hhh4_formula.html">fe</a></code> and <code><a href="hhh4_formula.html">ri</a></code>.
	Since <span class="pkg">surveillance</span> 1.8-2, named vectors are matched
	against the coefficient names in the model (where unmatched
	start values are silently ignored), and need not be complete,
	e.g., <code>start = list(fixed = c("-log(overdisp)" = 0.5))</code>
	(default: 2) for a <code>family = "NegBin1"</code> model.
	In contrast, an unnamed start vector must specify the full set
	of parameters as used by the model.</p></dd>
      <dt><code>data</code></dt>
<dd><p>a named list of covariates that are to be
	included as fixed effects (see <code><a href="hhh4_formula.html">fe</a></code>) in any of the 3
	component formulae.
	By default, the time variable <code>t</code> is available and used for
	seasonal effects created by <code><a href="addSeason2formula.html">addSeason2formula</a></code>.
	In general, covariates in this list can be either vectors of
	length <code><a href="https://rdrr.io/r/base/nrow.html">nrow(stsObj)</a></code> interpreted as time-varying but
	common across all units, or matrices of the same dimension as
	the disease counts <code><a href="stsSlots.html">observed(stsObj)</a></code>.</p></dd>
      <dt><code>keep.terms</code></dt>
<dd><p>logical indicating if the terms object
	used in the fit is to be kept as part of the returned object.
	This is usually not necessary, since the terms object is
	reconstructed by the <code><a href="https://rdrr.io/r/stats/terms.html">terms</a></code>-method for class
	<code>"hhh4"</code> if necessary (based on <code>stsObj</code> and
	<code>control</code>, which are both part of the returned
	<code>"hhh4"</code> object).</p></dd>
    
</dl>
<p>The auxiliary function <code><a href="makeControl.html">makeControl</a></code> might be useful to
    create such a list of control parameters.</p>
</dd>
    <dt class="col-sm-3" id="ref-arguments name">check.analyticals</dt>
      <dd class="col-sm-9" id="ref-arguments desc"><p>logical (or a subset of
    <code><a href="https://rdrr.io/r/base/c.html">c("numDeriv", "maxLik")</a></code>), indicating if (how) the implemented
    analytical score vector and Fisher information matrix should be
    checked against numerical derivatives at the parameter starting values,
    using the packages <span class="pkg">numDeriv</span> and/or <span class="pkg">maxLik</span>. If activated,
    <code>hhh4</code> will return a list containing the analytical and numerical
    derivatives for comparison (no ML estimation will be performed). 
    This is mainly intended for internal use by the package developers.</p></dd>
    </dl>
<h2 class="hasAnchor" id="value">
<a class="anchor" href="#value"></a>Value</h2>

    <p><code>hhh4</code> returns an object of class <code>"hhh4"</code>,
  which is a list containing the following components:</p>
<dt>coefficients</dt>
<dd><p>named vector with estimated (regression) parameters of the model</p></dd>
  <dt>se</dt>
<dd><p>estimated standard errors (for regression parameters)</p></dd>
  <dt>cov</dt>
<dd><p>covariance matrix (for regression parameters)</p></dd>
  <dt>Sigma</dt>
<dd><p>estimated variance-covariance matrix of random effects</p></dd>
  <dt>Sigma.orig</dt>
<dd><p>estimated variance parameters on internal scale used
    for optimization</p></dd>
  <dt>Sigma.cov</dt>
<dd><p>inverse of marginal Fisher information (on internal
    scale), i.e., the asymptotic covariance matrix of <code>Sigma.orig</code></p></dd>
  <dt>call</dt>
<dd><p>the matched call</p></dd>
  <dt>dim</dt>
<dd><p>vector with number of fixed and random effects in the model</p></dd>
  <dt>loglikelihood</dt>
<dd><p>(penalized) loglikelihood evaluated at the MLE</p></dd>
  <dt>margll</dt>
<dd><p>(approximate) log marginal likelihood should the model contain random effects</p></dd>
  <dt>convergence</dt>
<dd><p>logical. Did optimizer converge?</p></dd>
  <dt>fitted.values</dt>
<dd><p>fitted mean values \(\mu_{i,t}\)</p></dd>
  <dt>control</dt>
<dd><p>control object of the fit</p></dd>
  <dt>terms</dt>
<dd><p>the terms object used in the fit if <code>keep.terms = TRUE</code>
    and <code>NULL</code> otherwise</p></dd>
  <dt>stsObj</dt>
<dd><p>the supplied <code>stsObj</code></p></dd>
  <dt>lags</dt>
<dd><p>named integer vector of length two containing the lags
    used for the epidemic components <code>"ar"</code> and <code>"ne"</code>,
    respectively. The corresponding lag is <code>NA</code> if the component
    was not included in the model.</p></dd>
  <dt>nObs</dt>
<dd><p>number of observations used for fitting the model</p></dd>
  <dt>nTime</dt>
<dd><p>number of time points used for fitting the model</p></dd>
  <dt>nUnit</dt>
<dd><p>number of units (e.g. areas) used for fitting the model</p></dd>
  <dt>runtime</dt>
<dd><p>the <code><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></code>-queried time taken
    to fit the model, i.e., a named numeric vector of length 5 of class
    <code>"proc_time"</code></p></dd>

    <h2 class="hasAnchor" id="details">
<a class="anchor" href="#details"></a>Details</h2>

    <p>An endemic-epidemic multivariate time-series model for infectious
  disease counts \(Y_{it}\) from units \(i=1,\dots,I\) during
  periods \(t=1,\dots,T\) was proposed by Held et al (2005) and was
  later extended in a series of papers (Paul et al, 2008; Paul and Held,
  2011; Held and Paul, 2012; Meyer and Held, 2014).
  In its most general formulation, this so-called <code>hhh4</code> (or HHH or
  \(H^3\) or triple-H) model assumes that, conditional on past
  observations, \(Y_{it}\) has a Poisson or negative binomial
  distribution with mean
  $$\mu_{it} = \lambda_{it} y_{i,t-1} + 
                   \phi_{it} \sum_{j\neq i} w_{ji} y_{j,t-1} +
                   e_{it} \nu_{it}  $$
  In the case of a negative binomial model, the conditional 
  variance is \(\mu_{it}(1+\psi_i\mu_{it})\) 
  with overdispersion parameters \(\psi_i &gt; 0\) (possibly shared
  across different units, e.g., \(\psi_i\equiv\psi\)).
  Univariate time series of counts \(Y_t\) are supported as well, in
  which case <code>hhh4</code> can be regarded as an extension of
  <code><a href="https://rdrr.io/pkg/MASS/man/glm.nb.html">glm.nb</a></code> to account for autoregression.
  See the Examples below for a comparison of an endemic-only
  <code>hhh4</code> model with a corresponding <code>glm.nb</code>.</p>  
<p>The three unknown quantities of the mean \(\mu_{it}\),</p>
<ul>
<li><p>\(\lambda_{it}\) in the autoregressive (<code>ar</code>) component,</p></li>
<li><p>\(\phi_{it}\) in the neighbour-driven (<code>ne</code>) component, and</p></li>
<li><p>\(\nu_{it}\) in the endemic (<code>end</code>) component,</p></li>
</ul>
<p>are log-linear predictors incorporating time-/unit-specific
  covariates. They may also contain unit-specific random intercepts
  as proposed by Paul and Held (2011). The endemic mean is usually
  modelled proportional to a unit-specific offset \(e_{it}\)
  (e.g., population numbers or fractions); it is possible to include
  such multiplicative offsets in the epidemic components as well.
  The \(w_{ji}\) are transmission weights reflecting the flow of
  infections from unit \(j\) to unit \(i\). If weights vary over time
  (prespecified as a 3-dimensional array \((w_{jit})\)), the
  <code>ne</code> sum in the mean uses \(w_{jit} y_{j,t-1}\).
  In spatial <code>hhh4</code> applications, the “units” refer to
  geographical regions and the weights could be derived from movement
  network data. Alternatively, the weights \(w_{ji}\) can be
  estimated parametrically as a function of adjacency order (Meyer and
  Held, 2014), see <code><a href="hhh4_W.html">W_powerlaw</a></code>.</p>
<p>(Penalized) Likelihood inference for such <code>hhh4</code> models has been
  established by Paul and Held (2011) with extensions for parametric
  neighbourhood weights by Meyer and Held (2014).
  Supplied with the analytical score function and Fisher information,
  the function <code>hhh4</code> by default uses the quasi-Newton algorithm
  available through <code><a href="https://rdrr.io/r/stats/nlminb.html">nlminb</a></code> to maximize the log-likelihood.
  Convergence is usually fast even for a large number of parameters.
  If the model contains random effects, the penalized and marginal
  log-likelihoods are maximized alternately until convergence.</p>
    <h2 class="hasAnchor" id="see-also">
<a class="anchor" href="#see-also"></a>See also</h2>

    <div class="dont-index">
<p>See the special functions <code><a href="hhh4_formula.html">fe</a></code>, <code><a href="hhh4_formula.html">ri</a></code> and the
  examples below for how to specify unit-specific effects.</p>
<p>Further details on the modelling approach and illustrations of its
  implementation can be found in <code>vignette("hhh4")</code> and
  <code>vignette("hhh4_spacetime")</code>.</p>
</div>
    <h2 class="hasAnchor" id="author">
<a class="anchor" href="#author"></a>Author</h2>

    <p>Michaela Paul, Sebastian Meyer, Leonhard Held</p>
    <h2 class="hasAnchor" id="references">
<a class="anchor" href="#references"></a>References</h2>

    <p>Held, L., Höhle, M. and Hofmann, M. (2005):
    A statistical framework for the analysis of multivariate infectious
    disease surveillance counts.
    <em>Statistical Modelling</em>, <b>5</b> (3), 187-199.
    doi: <a href="https://doi.org/10.1191/1471082X05st098oa">10.1191/1471082X05st098oa</a></p>    
<p>Paul, M., Held, L. and Toschke, A. M. (2008):
    Multivariate modelling of infectious disease surveillance data.
    <em>Statistics in Medicine</em>, <b>27</b> (29), 6250-6267.
    doi: <a href="https://doi.org/10.1002/sim.4177">10.1002/sim.4177</a></p>
<p>Paul, M. and Held, L. (2011):
    Predictive assessment of a non-linear random effects model for
    multivariate time series of infectious disease counts.
    <em>Statistics in Medicine</em>, <b>30</b> (10), 1118-1136.
    doi: <a href="https://doi.org/10.1002/sim.4177">10.1002/sim.4177</a></p>
<p>Held, L. and Paul, M. (2012):
    Modeling seasonality in space-time infectious disease surveillance data.
    <em>Biometrical Journal</em>, <b>54</b> (6), 824-843.
    doi: <a href="https://doi.org/10.1002/bimj.201200037">10.1002/bimj.201200037</a></p>    
<p>Meyer, S. and Held, L. (2014):
    Power-law models for infectious disease spread.
    <em>The Annals of Applied Statistics</em>, <b>8</b> (3), 1612-1639.
    doi: <a href="https://doi.org/10.1214/14-AOAS743">10.1214/14-AOAS743</a></p>
<p>Meyer, S., Held, L. and Höhle, M. (2017):
    Spatio-temporal analysis of epidemic phenomena using the <span style="R">R</span> package
    <span class="pkg">surveillance</span>.
    <em>Journal of Statistical Software</em>, <b>77</b> (11), 1-55.
    doi: <a href="https://doi.org/10.18637/jss.v077.i11">10.18637/jss.v077.i11</a></p>

    <h2 class="hasAnchor" id="examples">
<a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><code class="sourceCode R"><span class="co">######################</span>
<span class="co">## Univariate examples</span>
<span class="co">######################</span>

<span class="co">### weekly counts of salmonella agona cases, UK, 1990-1995</span>

<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"salmonella.agona"</span><span class="op">)</span>
<span class="co">## convert old "disProg" to new "sts" data class</span>
<span class="va">salmonella</span> <span class="op">&lt;-</span> <span class="fu"><a href="disProg2sts.html">disProg2sts</a></span><span class="op">(</span><span class="va">salmonella.agona</span><span class="op">)</span>
<span class="va">salmonella</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">salmonella</span><span class="op">)</span>

<span class="co">## generate formula for an (endemic) time trend and seasonality</span>
<span class="va">f.end</span> <span class="op">&lt;-</span> <span class="fu"><a href="addSeason2formula.html">addSeason2formula</a></span><span class="op">(</span>f <span class="op">=</span> <span class="op">~</span><span class="fl">1</span> <span class="op">+</span> <span class="va">t</span>, S <span class="op">=</span> <span class="fl">1</span>, period <span class="op">=</span> <span class="fl">52</span><span class="op">)</span>
<span class="va">f.end</span>
<span class="co">## specify a simple autoregressive negative binomial model</span>
<span class="va">model1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>ar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>f <span class="op">=</span> <span class="op">~</span><span class="fl">1</span><span class="op">)</span>, end <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>f <span class="op">=</span> <span class="va">f.end</span><span class="op">)</span>, family <span class="op">=</span> <span class="st">"NegBin1"</span><span class="op">)</span>
<span class="co">## fit this model to the data</span>
<span class="va">res</span> <span class="op">&lt;-</span> <span class="fu">hhh4</span><span class="op">(</span><span class="va">salmonella</span>, <span class="va">model1</span><span class="op">)</span>
<span class="co">## summarize the model fit</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">res</span>, idx2Exp<span class="op">=</span><span class="fl">1</span>, amplitudeShift<span class="op">=</span><span class="cn">TRUE</span>, maxEV<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">res</span>, type <span class="op">=</span> <span class="st">"season"</span>, components <span class="op">=</span> <span class="st">"end"</span><span class="op">)</span>


<span class="co">### weekly counts of meningococcal infections, Germany, 2001-2006</span>

<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"influMen"</span><span class="op">)</span>
<span class="va">fluMen</span> <span class="op">&lt;-</span> <span class="fu"><a href="disProg2sts.html">disProg2sts</a></span><span class="op">(</span><span class="va">influMen</span><span class="op">)</span>
<span class="va">meningo</span> <span class="op">&lt;-</span> <span class="va">fluMen</span><span class="op">[</span>, <span class="st">"meningococcus"</span><span class="op">]</span>
<span class="va">meningo</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">meningo</span><span class="op">)</span>

<span class="co">## again a simple autoregressive NegBin model with endemic seasonality</span>
<span class="va">meningoFit</span> <span class="op">&lt;-</span> <span class="fu">hhh4</span><span class="op">(</span>stsObj <span class="op">=</span> <span class="va">meningo</span>, control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    ar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>f <span class="op">=</span> <span class="op">~</span><span class="fl">1</span><span class="op">)</span>,
    end <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>f <span class="op">=</span> <span class="fu"><a href="addSeason2formula.html">addSeason2formula</a></span><span class="op">(</span>f <span class="op">=</span> <span class="op">~</span><span class="fl">1</span>, S <span class="op">=</span> <span class="fl">1</span>, period <span class="op">=</span> <span class="fl">52</span><span class="op">)</span><span class="op">)</span>,
    family <span class="op">=</span> <span class="st">"NegBin1"</span>
<span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">meningoFit</span>, idx2Exp<span class="op">=</span><span class="cn">TRUE</span>, amplitudeShift<span class="op">=</span><span class="cn">TRUE</span>, maxEV<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">meningoFit</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">meningoFit</span>, type <span class="op">=</span> <span class="st">"season"</span>, components <span class="op">=</span> <span class="st">"end"</span><span class="op">)</span>


<span class="co">########################</span>
<span class="co">## Multivariate examples</span>
<span class="co">########################</span>

<span class="co">### bivariate analysis of influenza and meningococcal infections</span>
<span class="co">### (see Paul et al, 2008)</span>

<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">fluMen</span>, same.scale <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
     
<span class="co">## Fit a negative binomial model with</span>
<span class="co">## - autoregressive component: disease-specific intercepts</span>
<span class="co">## - neighbour-driven component: only transmission from flu to men</span>
<span class="co">## - endemic component: S=3 and S=1 sine/cosine pairs for flu and men, respectively</span>
<span class="co">## - disease-specific overdispersion</span>

<span class="va">WfluMen</span> <span class="op">&lt;-</span> <span class="fu"><a href="stsSlots.html">neighbourhood</a></span><span class="op">(</span><span class="va">fluMen</span><span class="op">)</span>
<span class="va">WfluMen</span><span class="op">[</span><span class="st">"meningococcus"</span>,<span class="st">"influenza"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span>
<span class="va">WfluMen</span>
<span class="va">f.end_fluMen</span> <span class="op">&lt;-</span> <span class="fu"><a href="addSeason2formula.html">addSeason2formula</a></span><span class="op">(</span>f <span class="op">=</span> <span class="op">~</span> <span class="op">-</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="hhh4_formula.html">fe</a></span><span class="op">(</span><span class="fl">1</span>, which <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="cn">TRUE</span>, <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>,
                                  S <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">1</span><span class="op">)</span>, period <span class="op">=</span> <span class="fl">52</span><span class="op">)</span>
<span class="va">f.end_fluMen</span>
<span class="va">fluMenFit</span> <span class="op">&lt;-</span> <span class="fu">hhh4</span><span class="op">(</span><span class="va">fluMen</span>, control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    ar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>f <span class="op">=</span> <span class="op">~</span> <span class="op">-</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="hhh4_formula.html">fe</a></span><span class="op">(</span><span class="fl">1</span>, unitSpecific <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>,
    ne <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>f <span class="op">=</span> <span class="op">~</span> <span class="fl">1</span>, weights <span class="op">=</span> <span class="va">WfluMen</span><span class="op">)</span>,
    end <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>f <span class="op">=</span> <span class="va">f.end_fluMen</span><span class="op">)</span>,
    family <span class="op">=</span> <span class="st">"NegBinM"</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">fluMenFit</span>, idx2Exp<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">fluMenFit</span>, type <span class="op">=</span> <span class="st">"season"</span>, components <span class="op">=</span> <span class="st">"end"</span>, unit <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">fluMenFit</span>, type <span class="op">=</span> <span class="st">"season"</span>, components <span class="op">=</span> <span class="st">"end"</span>, unit <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="co"># \dontshow{</span>
    <span class="co">## regression test for amplitude/shift transformation of sine-cosine pairs</span>
    <span class="co">## coefficients were wrongly matched in surveillance &lt; 1.18.0</span>
    <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">fluMenFit</span>, amplitudeShift <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">[</span><span class="st">"end.A(2 * pi * t/52).meningococcus"</span><span class="op">]</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">fluMenFit</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"end."</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"sin"</span>,<span class="st">"cos"</span><span class="op">)</span>, <span class="st">"(2 * pi * t/52).meningococcus"</span><span class="op">)</span><span class="op">]</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="co"># }</span>


<span class="co">### weekly counts of measles, Weser-Ems region of Lower Saxony, Germany</span>

<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"measlesWeserEms"</span><span class="op">)</span>
<span class="va">measlesWeserEms</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">measlesWeserEms</span><span class="op">)</span>  <span class="co"># note the two districts with zero cases</span>

<span class="co">## we could fit the same simple model as for the salmonella cases above</span>
<span class="va">model1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    ar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>f <span class="op">=</span> <span class="op">~</span><span class="fl">1</span><span class="op">)</span>,
    end <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>f <span class="op">=</span> <span class="fu"><a href="addSeason2formula.html">addSeason2formula</a></span><span class="op">(</span><span class="op">~</span><span class="fl">1</span> <span class="op">+</span> <span class="va">t</span>, period <span class="op">=</span> <span class="fl">52</span><span class="op">)</span><span class="op">)</span>,
    family <span class="op">=</span> <span class="st">"NegBin1"</span>
<span class="op">)</span>
<span class="va">measlesFit</span> <span class="op">&lt;-</span> <span class="fu">hhh4</span><span class="op">(</span><span class="va">measlesWeserEms</span>, <span class="va">model1</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">measlesFit</span>, idx2Exp<span class="op">=</span><span class="cn">TRUE</span>, amplitudeShift<span class="op">=</span><span class="cn">TRUE</span>, maxEV<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>

<span class="co">## but we should probably at least use a population offset in the endemic</span>
<span class="co">## component to reflect heterogeneous incidence levels of the districts,</span>
<span class="co">## and account for spatial dependence (here just using first-order adjacency)</span>
<span class="va">measlesFit2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">measlesFit</span>,
    end <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>offset <span class="op">=</span> <span class="fu"><a href="stsSlots.html">population</a></span><span class="op">(</span><span class="va">measlesWeserEms</span><span class="op">)</span><span class="op">)</span>,
    ne <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>f <span class="op">=</span> <span class="op">~</span><span class="fl">1</span>, weights <span class="op">=</span> <span class="fu"><a href="stsSlots.html">neighbourhood</a></span><span class="op">(</span><span class="va">measlesWeserEms</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">measlesFit2</span>, idx2Exp<span class="op">=</span><span class="cn">TRUE</span>, amplitudeShift<span class="op">=</span><span class="cn">TRUE</span>, maxEV<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">measlesFit2</span>, units <span class="op">=</span> <span class="cn">NULL</span>, hide0s <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="co">## 'measlesFit2' corresponds to the 'measlesFit_basic' model in</span>
<span class="co">## vignette("hhh4_spacetime"). See there for further analyses,</span>
<span class="co">## including vaccination coverage as a covariate,</span>
<span class="co">## spatial power-law weights, and random intercepts.</span>


<span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span>
<span class="co">### last but not least, a more sophisticated (and time-consuming)</span>
<span class="co">### analysis of weekly counts of influenza from 140 districts in</span>
<span class="co">### Southern Germany (originally analysed by Paul and Held, 2011,</span>
<span class="co">### and revisited by Held and Paul, 2012, and Meyer and Held, 2014)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"fluBYBW"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">fluBYBW</span>, type <span class="op">=</span> <span class="va">observed</span> <span class="op">~</span> <span class="va">time</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">fluBYBW</span>, type <span class="op">=</span> <span class="va">observed</span> <span class="op">~</span> <span class="va">unit</span>,
     <span class="co">## mean yearly incidence per 100.000 inhabitants (8 years)</span>
     population <span class="op">=</span> <span class="va">fluBYBW</span><span class="op">@</span><span class="va">map</span><span class="op">$</span><span class="va">X31_12_01</span> <span class="op">/</span> <span class="fl">100000</span> <span class="op">*</span> <span class="fl">8</span><span class="op">)</span>

<span class="co">## For the full set of models for data("fluBYBW") as analysed by</span>
<span class="co">## Paul and Held (2011), including predictive model assessement</span>
<span class="co">## using proper scoring rules, see the (computer-intensive)</span>
<span class="co">## demo("fluBYBW") script:</span>
<span class="va">demoscript</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="st">"demo"</span>, <span class="st">"fluBYBW.R"</span><span class="op">)</span>,
                          package <span class="op">=</span> <span class="st">"surveillance"</span><span class="op">)</span>
<span class="va">demoscript</span>
<span class="co">#file.show(demoscript)</span>

<span class="co">## Here we fit the improved power-law model of Meyer and Held (2014)</span>
<span class="co">## - autoregressive component: random intercepts + S = 1 sine/cosine pair</span>
<span class="co">## - neighbour-driven component: random intercepts + S = 1 sine/cosine pair</span>
<span class="co">##   + population gravity with normalized power-law weights</span>
<span class="co">## - endemic component: random intercepts + trend + S = 3 sine/cosine pairs</span>
<span class="co">## - random intercepts are iid but correlated between components</span>
<span class="va">f.S1</span> <span class="op">&lt;-</span> <span class="fu"><a href="addSeason2formula.html">addSeason2formula</a></span><span class="op">(</span>
    <span class="op">~</span><span class="op">-</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="hhh4_formula.html">ri</a></span><span class="op">(</span>type<span class="op">=</span><span class="st">"iid"</span>, corr<span class="op">=</span><span class="st">"all"</span><span class="op">)</span>,
    S <span class="op">=</span> <span class="fl">1</span>, period <span class="op">=</span> <span class="fl">52</span><span class="op">)</span>
<span class="va">f.end.S3</span> <span class="op">&lt;-</span> <span class="fu"><a href="addSeason2formula.html">addSeason2formula</a></span><span class="op">(</span>
    <span class="op">~</span><span class="op">-</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="hhh4_formula.html">ri</a></span><span class="op">(</span>type<span class="op">=</span><span class="st">"iid"</span>, corr<span class="op">=</span><span class="st">"all"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="op">(</span><span class="va">t</span><span class="op">-</span><span class="fl">208</span><span class="op">)</span><span class="op">/</span><span class="fl">100</span><span class="op">)</span>,
    S <span class="op">=</span> <span class="fl">3</span>, period <span class="op">=</span> <span class="fl">52</span><span class="op">)</span>

<span class="co">## for power-law weights, we need adjaceny orders, which can be</span>
<span class="co">## computed from the binary adjacency indicator matrix</span>
<span class="va">nbOrder1</span> <span class="op">&lt;-</span> <span class="fu"><a href="stsSlots.html">neighbourhood</a></span><span class="op">(</span><span class="va">fluBYBW</span><span class="op">)</span>
<span class="fu"><a href="stsSlots.html">neighbourhood</a></span><span class="op">(</span><span class="va">fluBYBW</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="nbOrder.html">nbOrder</a></span><span class="op">(</span><span class="va">nbOrder1</span>, <span class="fl">15</span><span class="op">)</span>

<span class="co">## full model specification</span>
<span class="va">fluModel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    ar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>f <span class="op">=</span> <span class="va">f.S1</span><span class="op">)</span>,
    ne <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>f <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.formula.html">update.formula</a></span><span class="op">(</span><span class="va">f.S1</span>, <span class="op">~</span> <span class="va">.</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">pop</span><span class="op">)</span><span class="op">)</span>,
              weights <span class="op">=</span> <span class="fu"><a href="hhh4_W.html">W_powerlaw</a></span><span class="op">(</span>maxlag<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="fu"><a href="stsSlots.html">neighbourhood</a></span><span class="op">(</span><span class="va">fluBYBW</span><span class="op">)</span><span class="op">)</span>,
                                   normalize <span class="op">=</span> <span class="cn">TRUE</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>,
    end <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>f <span class="op">=</span> <span class="va">f.end.S3</span>, offset <span class="op">=</span> <span class="fu"><a href="stsSlots.html">population</a></span><span class="op">(</span><span class="va">fluBYBW</span><span class="op">)</span><span class="op">)</span>,
    family <span class="op">=</span> <span class="st">"NegBin1"</span>, data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>pop <span class="op">=</span> <span class="fu"><a href="stsSlots.html">population</a></span><span class="op">(</span><span class="va">fluBYBW</span><span class="op">)</span><span class="op">)</span>,
    optimizer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>variance <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"Nelder-Mead"</span><span class="op">)</span><span class="op">)</span>,
    verbose <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="co">## CAVE: random effects considerably increase the runtime of model estimation</span>
<span class="co">## (It is usually advantageous to first fit a model with simple intercepts</span>
<span class="co">## to obtain reasonable start values for the other parameters.)</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>  <span class="co"># because random intercepts are initialized randomly</span>
<span class="va">fluFit</span> <span class="op">&lt;-</span> <span class="fu">hhh4</span><span class="op">(</span><span class="va">fluBYBW</span>, <span class="va">fluModel</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">fluFit</span>, idx2Exp <span class="op">=</span> <span class="cn">TRUE</span>, amplitudeShift <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">fluFit</span>, type <span class="op">=</span> <span class="st">"fitted"</span>, total <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">fluFit</span>, type <span class="op">=</span> <span class="st">"season"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/range.html">range</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">fluFit</span>, type <span class="op">=</span> <span class="st">"maxEV"</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">fluFit</span>, type <span class="op">=</span> <span class="st">"maps"</span>, prop <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="fu">gridExtra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html">grid.arrange</a></span><span class="op">(</span>
    grobs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ar"</span>, <span class="st">"ne"</span>, <span class="st">"end"</span><span class="op">)</span>, <span class="kw">function</span> <span class="op">(</span><span class="va">comp</span><span class="op">)</span>
        <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">fluFit</span>, type <span class="op">=</span> <span class="st">"ri"</span>, component <span class="op">=</span> <span class="va">comp</span>, main <span class="op">=</span> <span class="va">comp</span>,
             exp <span class="op">=</span> <span class="cn">TRUE</span>, sub <span class="op">=</span> <span class="st">"multiplicative effect"</span><span class="op">)</span><span class="op">)</span>,
    nrow <span class="op">=</span> <span class="fl">1</span>, ncol <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">fluFit</span>, type <span class="op">=</span> <span class="st">"neweights"</span>, xlab <span class="op">=</span> <span class="st">"adjacency order"</span><span class="op">)</span>
<span class="op">}</span>


<span class="co">########################################################################</span>
<span class="co">## An endemic-only "hhh4" model can also be estimated using MASS::glm.nb</span>
<span class="co">########################################################################</span>

<span class="co">## weekly counts of measles, Weser-Ems region of Lower Saxony, Germany</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"measlesWeserEms"</span><span class="op">)</span>

<span class="co">## fit an endemic-only "hhh4" model</span>
<span class="co">## with time covariates and a district-specific offset</span>
<span class="va">hhh4fit</span> <span class="op">&lt;-</span> <span class="fu">hhh4</span><span class="op">(</span><span class="va">measlesWeserEms</span>, control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    end <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>f <span class="op">=</span> <span class="fu"><a href="addSeason2formula.html">addSeason2formula</a></span><span class="op">(</span><span class="op">~</span><span class="fl">1</span> <span class="op">+</span> <span class="va">t</span>, period <span class="op">=</span> <span class="va">measlesWeserEms</span><span class="op">@</span><span class="va">freq</span><span class="op">)</span>,
               offset <span class="op">=</span> <span class="fu"><a href="stsSlots.html">population</a></span><span class="op">(</span><span class="va">measlesWeserEms</span><span class="op">)</span><span class="op">)</span>,
    ar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>f <span class="op">=</span> <span class="op">~</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span>, ne <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>f <span class="op">=</span> <span class="op">~</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span>, family <span class="op">=</span> <span class="st">"NegBin1"</span>,
    subset <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">measlesWeserEms</span><span class="op">)</span>
<span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">hhh4fit</span><span class="op">)</span>

<span class="co">## fit the same model using MASS::glm.nb</span>
<span class="va">measlesWeserEmsData</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">measlesWeserEms</span>, tidy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">measlesWeserEmsData</span><span class="op">$</span><span class="va">t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">hhh4fit</span><span class="op">$</span><span class="va">control</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">t</span><span class="op">)</span>
<span class="va">glmnbfit</span> <span class="op">&lt;-</span> <span class="fu">MASS</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/glm.nb.html">glm.nb</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/formula.html">formula</a></span><span class="op">(</span><span class="va">hhh4fit</span><span class="op">)</span><span class="op">$</span><span class="va">end</span>, <span class="va">observed</span> <span class="op">~</span> <span class="va">.</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/offset.html">offset</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">population</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
    data <span class="op">=</span> <span class="va">measlesWeserEmsData</span>
<span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">glmnbfit</span><span class="op">)</span>

<span class="co">## Note that the overdispersion parameter is parametrized inversely.</span>
<span class="co">## The likelihood and point estimates are all the same.</span>
<span class="co">## However, the variance estimates are different: in glm.nb, the parameters</span>
<span class="co">## are estimated conditional on the overdispersion theta.</span>

<span class="co"># \dontshow{</span>
<span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html">stopifnot</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/all.equal.html">all.equal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/logLik.html">logLik</a></span><span class="op">(</span><span class="va">hhh4fit</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/logLik.html">logLik</a></span><span class="op">(</span><span class="va">glmnbfit</span><span class="op">)</span><span class="op">)</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/all.equal.html">all.equal</a></span><span class="op">(</span><span class="fl">1</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">hhh4fit</span><span class="op">)</span><span class="op">[[</span><span class="st">"overdisp"</span><span class="op">]</span><span class="op">]</span>, <span class="va">glmnbfit</span><span class="op">$</span><span class="va">theta</span>, tolerance <span class="op">=</span> <span class="fl">1e-6</span><span class="op">)</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/all.equal.html">all.equal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">hhh4fit</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">glmnbfit</span><span class="op">)</span>,
              tolerance <span class="op">=</span> <span class="fl">1e-6</span>, check.attributes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/all.equal.html">all.equal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span><span class="op">(</span><span class="va">hhh4fit</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span><span class="op">(</span><span class="va">glmnbfit</span><span class="op">)</span>,
              tolerance <span class="op">=</span> <span class="fl">1e-6</span>, check.attributes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="op">)</span>
<span class="co"># }</span>
</code></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <div class="sticky-top">
    <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>

    </nav>
</div>
  </div>
</div>


      <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Maintained by <a href="http://www.imbe.med.uni-erlangen.de/cms/sebastian_meyer.html" class="external-link">Sebastian Meyer</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 1.6.1.9001. Hosted on <a href="https://R-forge.R-project.org/projects/surveillance/" class="external-link"><img src="https://r-forge.r-project.org/themes/rforge/imagesrf/logo.png" height="18" alt="R-Forge"></a></p>
</div>

      </footer>
</div>

  


  

  </body>
</html>

