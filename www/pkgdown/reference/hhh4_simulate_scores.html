<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Proper Scoring Rules for Simulations from hhh4 Models — hhh4_simulate_scores • surveillance</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/MathJax-3.2.2/tex-chtml.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Proper Scoring Rules for Simulations from hhh4 Models — hhh4_simulate_scores"><meta name="description" content="Calculate proper scoring rules based on simulated predictive distributions."><meta property="og:description" content="Calculate proper scoring rules based on simulated predictive distributions."><meta name="twitter:card" content="summary"><meta name="twitter:creator" content="@bastistician"><meta name="twitter:site" content="@bastistician"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">surveillance</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.23.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="../articles/pkgdown/overview.html">Overview</a></li>
<li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
<li class="nav-item"><a class="nav-link" href="../articles/pkgdown/events.html">Events</a></li>
<li class="nav-item"><a class="nav-link" href="../articles/pkgdown/bibliography.html">Bibliography</a></li>
      </ul><ul class="navbar-nav"></ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Proper Scoring Rules for Simulations from <code>hhh4</code> Models</h1>

      <div class="d-none name"><code>hhh4_simulate_scores.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Calculate proper scoring rules based on simulated predictive distributions.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="co"># S3 method for class 'hhh4sims'</span></span>
<span><span class="fu"><a href="scores.html">scores</a></span><span class="op">(</span><span class="va">x</span>, which <span class="op">=</span> <span class="st">"rps"</span>, units <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">...</span>, drop <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co"># S3 method for class 'hhh4simslist'</span></span>
<span><span class="fu"><a href="scores.html">scores</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>
    <p></p>
<dl><dt id="arg-x">x<a class="anchor" aria-label="anchor" href="#arg-x"></a></dt>
<dd><p>an object of class <code>"hhh4sims"</code> (as resulting from the
    <code><a href="hhh4_simulate.html">simulate</a></code>-method for
    <code>"<a href="hhh4.html">hhh4</a>"</code> models if <code>simplify = TRUE</code> was set),
    or an <code>"hhh4simslist"</code>, i.e.,
    a list of such simulations potentially obtained from different
    model fits (using the same simulation period).</p></dd>

  <dt id="arg-which">which<a class="anchor" aria-label="anchor" href="#arg-which"></a></dt>
<dd><p>a character vector indicating which proper scoring rules to compute.
    By default, only the ranked probability score (<code>"rps"</code>) is
    calculated. Other options include <code>"logs"</code> and <code>"dss"</code>.</p></dd>

  <dt id="arg-units">units<a class="anchor" aria-label="anchor" href="#arg-units"></a></dt>
<dd><p>if non-<code>NULL</code>, an integer or character vector indexing the
    columns of <code>x</code> for which to compute the scores.</p></dd>

  <dt id="arg-drop">drop<a class="anchor" aria-label="anchor" href="#arg-drop"></a></dt>
<dd><p>a logical indicating if univariate dimensions should be dropped
    (the default).</p></dd>

  <dt id="arg--">...<a class="anchor" aria-label="anchor" href="#arg--"></a></dt>
<dd><p>unused (argument of the generic).</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>This implementation can only compute <em>univariate scores</em>, i.e.,
  independently for each time point.</p>
<p>The logarithmic score is badly estimated if the domain is large and
  there are not enough samples to cover the underlying distribution in
  enough detail (the score becomes infinite when an observed value does
  not occur in the samples). An alternative is to use kernel density
  estimation as implemented in the <span style="R">R</span> package <a href="https://CRAN.R-project.org/package=scoringRules" class="external-link"><span class="pkg">scoringRules</span></a>.</p>
    </div>
    <div class="section level2">
    <h2 id="author">Author<a class="anchor" aria-label="anchor" href="#author"></a></h2>
    <p>Sebastian Meyer</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"salmAllOnset"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## fit a hhh4 model to the first 13 years</span></span>
<span><span class="va">salmModel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>end <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>f <span class="op">=</span> <span class="fu"><a href="addSeason2formula.html">addSeason2formula</a></span><span class="op">(</span><span class="op">~</span><span class="fl">1</span> <span class="op">+</span> <span class="va">t</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                  ar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>f <span class="op">=</span> <span class="op">~</span><span class="fl">1</span><span class="op">)</span>, family <span class="op">=</span> <span class="st">"NegBin1"</span>, subset <span class="op">=</span> <span class="fl">2</span><span class="op">:</span><span class="fl">678</span><span class="op">)</span></span>
<span><span class="va">salmFit</span> <span class="op">&lt;-</span> <span class="fu"><a href="hhh4.html">hhh4</a></span><span class="op">(</span><span class="va">salmAllOnset</span>, <span class="va">salmModel</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## simulate the next 20 weeks ahead (with very small 'nsim' for speed)</span></span>
<span><span class="va">salmSims</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/simulate.html" class="external-link">simulate</a></span><span class="op">(</span><span class="va">salmFit</span>, nsim <span class="op">=</span> <span class="fl">500</span>, seed <span class="op">=</span> <span class="fl">3</span>, subset <span class="op">=</span> <span class="fl">678</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fl">20</span><span class="op">)</span>,</span>
<span>                     y.start <span class="op">=</span> <span class="fu"><a href="stsSlots.html">observed</a></span><span class="op">(</span><span class="va">salmAllOnset</span><span class="op">)</span><span class="op">[</span><span class="fl">678</span>,<span class="op">]</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"fanplot"</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">salmSims</span>, <span class="st">"fan"</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">### calculate scores at each time point</span></span>
<span></span>
<span><span class="co">## using empirical distribution of simulated counts as forecast distribution</span></span>
<span><span class="fu"><a href="scores.html">scores</a></span><span class="op">(</span><span class="va">salmSims</span>, which <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"rps"</span>, <span class="st">"logs"</span>, <span class="st">"dss"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## observed count sometimes not covered by simulations -&gt; infinite log-score</span></span>
<span><span class="co">## =&gt; for a more detailed forecast, either considerably increase 'nsim', or:</span></span>
<span></span>
<span><span class="co">## 1. use continuous density() of simulated counts as forecast distribution</span></span>
<span><span class="va">fi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">salmSims</span>, <span class="fl">1</span>, <span class="kw">function</span> <span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/approxfun.html" class="external-link">approxfun</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/density.html" class="external-link">density</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">logs_kde</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mapply.html" class="external-link">mapply</a></span><span class="op">(</span><span class="kw">function</span> <span class="op">(</span><span class="va">f</span>, <span class="va">y</span><span class="op">)</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fu">f</span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                   f <span class="op">=</span> <span class="va">fi</span>, y <span class="op">=</span> <span class="fu"><a href="stsSlots.html">observed</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">salmSims</span>,<span class="st">"stsObserved"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="st">"empirical"</span> <span class="op">=</span> <span class="fu"><a href="scores.html">scores</a></span><span class="op">(</span><span class="va">salmSims</span>, <span class="st">"logs"</span><span class="op">)</span>, <span class="st">"density"</span> <span class="op">=</span> <span class="va">logs_kde</span><span class="op">)</span></span>
<span><span class="co">## a similar KDE approach is implemented in scoringRules::logs_sample()</span></span>
<span></span>
<span><span class="co">## 2. average conditional predictive NegBin's of simulated trajectories,</span></span>
<span><span class="co">##    currently only implemented in HIDDA.forecasting::dhhh4sims()</span></span>
<span></span>
<span></span>
<span><span class="co">### produce a PIT histogram</span></span>
<span></span>
<span><span class="co">## using empirical distribution of simulated counts as forecast distribition</span></span>
<span><span class="fu"><a href="pit.html">pit</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="stsSlots.html">observed</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">salmSims</span>, <span class="st">"stsObserved"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    pdistr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">salmSims</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="va">ecdf</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## long-term forecast is badly calibrated (lower tail is unused, see fan above)</span></span>
<span><span class="co">## we also get a warning for the same reason as infinite log-scores</span></span></code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Maintained by <a href="https://www.imbe.med.fau.de/person/sebastian-meyer" class="external-link">Sebastian Meyer</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.9000. Hosted on <a href="https://R-forge.R-project.org/projects/surveillance/" class="external-link"><img src="https://r-forge.r-project.org/themes/rforge/imagesrf/logo.png" height="18" alt="R-Forge"></a></p>
</div>

    </footer></div>



  </body></html>

